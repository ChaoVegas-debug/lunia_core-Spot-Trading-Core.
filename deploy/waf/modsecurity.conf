# Lunia Core ModSecurity configuration
# Hardened baseline referencing OWASP CRS

Include /etc/modsecurity.d/*.conf
Include /etc/modsecurity.d/owasp-crs/crs-setup.conf

SecRuleEngine On
SecRequestBodyAccess On
SecResponseBodyAccess Off
SecAuditEngine RelevantOnly
SecAuditLog /var/log/modsecurity/audit.log
SecAuditLogParts ABIJDEFHZ
SecAuditLogType Serial

SecRule REMOTE_ADDR "@ipMatchFromFile /etc/modsecurity/whitelist_ips.data" "id:10000,phase:1,pass,nolog"
SecRule REQUEST_HEADERS:Content-Type "application/json" "id:10001,phase:1,allow,ctl:requestBodyProcessor=JSON"

# Blocking aggressive scraping and credential stuffing
SecRule ARGS_NAMES "(?i)(password|token)" "id:10002,phase:2,deny,status:403,msg:'Sensitive param access'"

# Enforce authenticated requests for admin endpoints
SecRule REQUEST_URI "^/api/v1/(cores|system|dashboard)" "id:10003,phase:1,deny,status:401,chain"
    SecRule &REQUEST_HEADERS:Authorization "@eq 0"

# Throttle login attempts
SecAction "id:10004,phase:1,initcol:ip=%{REMOTE_ADDR},pass"
SecRule IP:login_counter "@gt 10" "id:10005,phase:1,deny,status:429,msg:'Too many login attempts'"
SecRule REQUEST_URI "^/api/v1/auth/login" "id:10006,phase:1,nolog,pass,chain"
    SecAction "setvar:ip.login_counter=+1,expirevar:ip.login_counter=300"

# Feature flag guard so WAF can be disabled for staging
SecRule &ENV:INFRA_PROD_ENABLED "@eq 0" "id:10007,phase:1,pass,nolog,ctl:ruleRemoveById=10000-10999"
